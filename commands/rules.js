const { sendMessage, sendLocalFileMessage, removeMessage, commandAnswer } = require('../helpers/telegraf');
const { setStatisticsData } = require('../helpers/db');

const { homeOption, closeOption, moduleNames } = require('../const/dictionary');

const moduleParam = {
    name: moduleNames.rules,
    keywords: ['–ø—Ä–∞–≤–∏–ª–∞'],
    chat: 'chat',
    silent: 'silent',
    dog: 'dog',
};

const initAction = async (ctx, { isHearsAction } = {}) => {
    await setStatisticsData(isHearsAction ? 'rules-hears' : 'rules-start');

    const messageText =
        'üìö –ü—Ä–∞–≤–∏–ª–∞\n\n' +
        '–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ —Å–æ–±—Ä–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞.\n' +
        '–î–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –ø—Ä–∞–≤–∏–ª –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ.';

    const buttons = {
        [`${moduleParam.name}:${moduleParam.chat}`]: '–ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞',
        [`${moduleParam.name}:${moduleParam.silent}`]: '–ó–∞–∫–æ–Ω –æ —Ç–∏—à–∏–Ω–µ',
        [`${moduleParam.name}:${moduleParam.dog}`]: '–ó–∞–∫–æ–Ω –æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ —Å–æ–±–∞–∫',
    };

    const isPrivateChat = ctx.chat?.type === 'private';

    await sendMessage(ctx, {
        text: messageText,
        buttons: {
            ...buttons,
            ...(isPrivateChat ? homeOption : {}),
            ...(!isPrivateChat ? closeOption : {}),
        },
    });

    await removeMessage(ctx);
    await commandAnswer(ctx);
};


const ruleSelectHandler = async (ctx, sectionName) => {
    await setStatisticsData(`rules-get:${sectionName}`);

    let text = '';

    const isPrivateChat = ctx.chat?.type === 'private';

    const buttons = {
        [moduleParam.name]: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥',
        ...(!isPrivateChat ? closeOption : {}),
    };


    const filePaths = {
        [moduleParam.silent]: './assets/273_70.pdf',
        [moduleParam.dog]: './assets/588_110.pdf',
    };

    if (sectionName === moduleParam.chat) {
        text =
            'üìñ –ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞\n\n' +
            '–î–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —á–∞—Ç–∞ —Å —Ü–µ–ª—å—é –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π, –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –£—á–∞—Å—Ç–∏–µ –≤ —á–∞—Ç–µ –æ–∑–Ω–∞—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏.\n\n' +
            '<b>üö´ –ó–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è:</b>\n' +
            '<blockquote>‚Ä¢ –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ–∑ –∏—Ö —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è (–∞–¥—Ä–µ—Å–∞, –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –ª–∏—á–Ω—ã–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏, –∞–∫–∫–∞—É–Ω—Ç—ã –∏ —Ç.–ø.);\n' +
            '‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫, –∞–∫—Ü–∏–π, –∞ —Ç–∞–∫–∂–µ –ª—é–±–æ–≥–æ –≤–∏–¥–∞ —Å–ø–∞–º–∞ –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏;\n' +
            '‚Ä¢ –ü—Ä–∏–∑—ã–≤—ã –∫ –ø—Ä–æ—Ç–∏–≤–æ–ø—Ä–∞–≤–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∞ –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏;\n' +
            '‚Ä¢ –û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, –∞–≥—Ä–µ—Å—Å–∏—è, —Ç—Ä–∞–≤–ª—è, –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –Ω–µ—É–≤–∞–∂–µ–Ω–∏—è –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º;\n' +
            '‚Ä¢ –£–º—ã—à–ª–µ–Ω–Ω–∞—è –¥–µ–∑–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∂–Ω—ã—Ö —Å–≤–µ–¥–µ–Ω–∏–π, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–∏ –ø–∞–Ω–∏–∫–∏ –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.</blockquote>\n\n' +
            '<b>üîï –†–µ–∂–∏–º —Ç–∏—à–∏–Ω—ã –∏ –æ—Ç–¥—ã—Ö–∞:</b>\n' +
            '<blockquote>‚Ä¢ –ü—Ä–æ—Å–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–±–ª—é–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ç–∏—à–∏–Ω—ã –∏ —É–≤–∞–∂–∞—Ç—å –ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥—Ä—É–≥–∏—Ö;\n' +
            '‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å 09:00 –¥–æ 22:00;\n' +
            '‚Ä¢ –í –ø–µ—Ä–∏–æ–¥ —Å 22:00 –¥–æ 09:00 –ø—Ä–æ—Å—å–±–∞ –≤–æ–∑–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –æ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–µ —Ç—Ä–µ–±—É—é—â–∏—Ö —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.</blockquote>\n\n' +
            '<b>‚öñÔ∏è –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ –º–µ—Ä—ã:</b>\n' +
            '<blockquote>‚Ä¢ –ó–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–ø—Ä–∞–≤–µ –≤—ã–Ω–µ—Å—Ç–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ;\n' +
            '‚Ä¢ –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –∏ —Ç—è–∂–µ—Å—Ç–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–æ—Ç 24 —á–∞—Å–æ–≤);\n' +
            '‚Ä¢ –í —Å–ª—É—á–∞–µ –≥—Ä—É–±—ã—Ö –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π –≤–æ–∑–º–æ–∂–Ω–∞ –±–µ—Å—Å—Ä–æ—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è;\n' +
            '‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞ —Å–æ–±–æ–π –ø—Ä–∞–≤–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è –≤ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.</blockquote>\n\n' +
            '<b>ü§ù –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏::</b>\n' +
            '<blockquote>‚Ä¢ –°–æ–±–ª—é–¥–∞–π—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É;\n' +
            '‚Ä¢ –£—á–∏—Ç—ã–≤–∞–π—Ç–µ, —á—Ç–æ –≤ —á–∞—Ç–µ –º–æ–≥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ª—é–¥–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–∑–≥–ª—è–¥–∞–º–∏ –∏ –º–Ω–µ–Ω–∏—è–º–∏; \n' +
            '‚Ä¢ –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ —Å–ø–æ—Ä–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏, –∞ –Ω–µ –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.</blockquote>';
    }

    if (sectionName === moduleParam.silent) {
        text =
            'üìñ –ó–∞–∫–æ–Ω –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞ ‚Ññ273-70 –æ —Ç–∏—à–∏–Ω–µ\n\n' +
            '<b>–í –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ —à—É–º–µ—Ç—å:</b>\n' +
            '<blockquote>‚Ä¢ –° 22:00 –¥–æ 08:00 –≤ –±—É–¥–Ω–∏–µ –¥–Ω–∏;\n' +
            '‚Ä¢ –° 22:00 –¥–æ 12:00 –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏.</blockquote>\n\n' +
            '–ö —à—É–º—É –æ—Ç–Ω–æ—Å—è—Ç—Å—è –≥—Ä–æ–º–∫–∞—è –º—É–∑—ã–∫–∞, –∫—Ä–∏–∫–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–≤—É–∫–æ—É—Å–∏–ª–∏–≤–∞—é—â–µ–π —Ç–µ—Ö–Ω–∏–∫–∏, —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –Ω–∞—Ä—É—à–∞—é—â–∏–µ –ø–æ–∫–æ–π –≥—Ä–∞–∂–¥–∞–Ω.\n\n' +
            '<b>–†–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã:</b>\n' +
            '<blockquote>‚Ä¢ –° 09:00 –¥–æ 19:00\n' +
            '‚Ä¢ –° –ø–µ—Ä–µ—Ä—ã–≤–æ–º —Å 13:00 –¥–æ 15:00</blockquote>';
    }

    if (sectionName === moduleParam.dog) {
        text =
            'üìñ –ó–∞–∫–æ–Ω –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞ ‚Ññ588-110 –æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ —Å–æ–±–∞–∫\n\n' +
            '<b>–ü–æ–≤–æ–¥–æ–∫.</b>\n' +
            '<blockquote>‚Ä¢ –í—Å–µ —Å–æ–±–∞–∫–∏ –≤–Ω–µ –º–µ—Å—Ç–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –æ–±—è–∑–∞–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ –ø–æ–≤–æ–¥–∫–µ.</blockquote>\n\n' +
            '<b>–ù–∞–º–æ—Ä–¥–Ω–∏–∫.</b>\n' +
            '<blockquote>‚Ä¢ –°–æ–±–∞–∫–∏ —Ä–æ—Å—Ç–æ–º –≤—ã—à–µ 40 —Å–º –≤ —Ö–æ–ª–∫–µ –∏ –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–º–∏ –ø–æ—Ä–æ–¥–∞–º–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏ –≤ –Ω–∞–º–æ—Ä–¥–Ω–∏–∫–µ –ø—Ä–∏ –≤—ã–≥—É–ª–µ.</blockquote>\n\n' +
            '<b>–î–ª–∏–Ω–∞ –ø–æ–≤–æ–¥–∫–∞.</b>\n' +
            '<blockquote>‚Ä¢ –í –º–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã—Ö –¥–æ–º–∞—Ö –∑–∞–∫–æ–Ω —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –∫—Ä—É–ø–Ω—ã–µ / –æ–ø–∞—Å–Ω—ã–µ —Å–æ–±–∞–∫–∏ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –Ω–µ –¥–∞–ª–µ–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ 80 —Å–º).</blockquote>\n\n' +
            '<b>–ó–∞–ø—Ä–µ—Ç—ã –ø–æ —É—Å–ª–æ–≤–∏—è–º –∏ –≤–æ–∑—Ä–∞—Å—Ç—É.</b>\n' +
            '<blockquote>‚Ä¢ –î–µ—Ç—è–º –¥–æ 16 –ª–µ—Ç –±–µ–∑ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –≤–∑—Ä–æ—Å–ª–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –≤—ã–≥—É–ª–∏–≤–∞—Ç—å –∫—Ä—É–ø–Ω—ã—Ö –∏–ª–∏ –æ–ø–∞—Å–Ω—ã—Ö —Å–æ–±–∞–∫.\n' +
            '‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤—ã–≥—É–ª–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫—Ä—É–ø–Ω—ã—Ö / –æ–ø–∞—Å–Ω—ã—Ö —Å–æ–±–∞–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.\n' +
            '‚Ä¢ –ù–µ–ª—å–∑—è –≤—ã–≥—É–ª–∏–≤–∞—Ç—å —Å–æ–±–∞–∫ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∞–ª–∫–æ–≥–æ–ª—å–Ω–æ–≥–æ –∏–ª–∏ –Ω–∞—Ä–∫–æ—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—å—è–Ω–µ–Ω–∏—è.</blockquote>\n\n' +
            '<b>–£–±–æ—Ä–∫–∞ –∑–∞ –∂–∏–≤–æ—Ç–Ω—ã–º.</b>\n' +
            '<blockquote>‚Ä¢ –í–ª–∞–¥–µ–ª—å—Ü—ã –æ–±—è–∑–∞–Ω—ã —É–±–∏—Ä–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –∂–∏–∑–Ω–µ–¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–≤–æ–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –æ–±—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.</blockquote>\n\n' +
            '<b>–ó–∞–ø—Ä–µ—Ç—ã –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö.</b>\n' +
            '<blockquote>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—Ä–µ—â—ë–Ω –≤—ã–≥—É–ª –Ω–∞ –¥–µ—Ç—Å–∫–∏—Ö –∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –ø–ª–æ—â–∞–¥–∫–∞—Ö, —É —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</blockquote>';
    }

    if (filePaths[sectionName]) {
        await sendLocalFileMessage(ctx, { text, buttons, filePath: filePaths[sectionName] });
    } else {
        await sendMessage(ctx, { text, buttons });
    }

    await removeMessage(ctx);
    await commandAnswer(ctx);
};

const callbackHandler = async (ctx, next) => {
    const data = ctx.callbackQuery.data;
    const [action, sectionName] = data.split(':');

    if (action === moduleParam.name) {
        await ruleSelectHandler(ctx, sectionName);
    }

    return next();
};

module.exports = (bot) => {
    bot.hears(moduleParam.keywords, (ctx) => initAction(ctx, { isHearsAction: true }));
    bot.command(moduleParam.name, (ctx) => initAction(ctx));
    bot.action(moduleParam.name, (ctx) => initAction(ctx));
    bot.on('callback_query', (ctx, next) => callbackHandler(ctx, next));
};
